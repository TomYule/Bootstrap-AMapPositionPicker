!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery","AMap"],t);else if("object"==typeof exports)module.exports=t(require("jquery"),require("AMap"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}function n(){var t='<div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerSearch" type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#idAMapPositionPickerSearchPanel"><span class="glyphicon glyphicon-search"></span>&nbsp;搜索</button></div>',i='<div id="idAMapPositionPickerSearchPanel" class="collapse"><input class="form-control input-sm" id="idAMapPositionPickerSearchInput"/><ul id="idAMapPositionPickerSearchResult" class="list-group"></ul></div>',e='<div style="position: absolute;z-index: 2;top:5px;right: 5px;">'+t+i+"</div>",n='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">请选择地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+e+'</div><input class="form-control input-sm" style="margin-top:5px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary btn-sm">确定</button><button type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button></div></div></div></div>';return n}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var o=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t.validateLngLat=function(t){var i=/^([+-]?(0?\d{1,2}(\.\d{1,6})?|1[0-7]?\d{1}(\.\d{1,6})?|180\.0{1,6}))[-;,]([-+]?([0-8]?\d{1}(\.\d{1,6})?|90(\.0{1,6})?))$/.exec(t);return i?{longitude:parseFloat(i[1]),latitude:parseFloat(i[5])}:null},t.LNGLAT_FORMATTER=["{longitude}-{latitude}","{longitude};{latitude}","{longitude},{latitude}"],t}(),a=function(){function i(t){return t.startsWith("#")?t.substring(1):(a+=1,"id_bapp_i"+a)}function n(n,a){if(this.name=n.name,n.selector instanceof jQuery)this.$widget=n.selector,this.created=!0;else if(t(n.selector).length>0)this.$widget=t(n.selector),this.created=!0;else{var r='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i(n.selector),name:n.name});this.$widget=t(r),this.created=!1}this.formatter=function(t){return e(n.formatter,t)},o.validate(a)&&this.$widget.val(this.formatter(a))}var a=-1;return n.prototype.render=function(t){var i=this.formatter(t);this.$widget.val(i)},n}(),r=function(){function e(t){R=t,a()}function a(){r(),s();var t=R.position();t&&t.isValid()?g(P(t)):(O&&O.setMap(null),A.val(""),R.opts.center.longitude&&R.opts.center.latitude&&q.setCenter(new i.LngLat(R.opts.center.longitude,R.opts.center.latitude))),I.modal("show")}function r(){null==I&&(I=t(n()),t(document.body).append(I),q=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){q.addControl(new i.ToolBar),q.addControl(new i.Scale),q.addControl(new i.OverView({isOpen:!0}))}),q.on("click",F),q.plugin("AMap.Geolocation",function(){E=new i.Geolocation({enableHighAccuracy:!0,timeout:3e3,maximumAge:0,convert:!0,panToLocation:!0,zoomToAccuracy:!0,markerOptions:{}})}),b=t("#idAMapPositionPickerMap"),k=t("#idAMapPositionPickerSelect"),y=t("#idAMapPositionPickerLocation"),w=t("#idAMapPositionPickerReset"),L=t("#idAMapPositionPickerClear"),A=t("#idAMapPositionPickerAddress"),M=t("#idAMapPositionPickerAlert"),x=t("#idAMapPositionPickerSearch"),S=t("#idAMapPositionPickerSearchPanel"),T=t("#idAMapPositionPickerSearchInput"),C=t("#idAMapPositionPickerSearchResult"),k.on("click",p),w.on("click",c),L.on("click",d),y.on("click",l),S.on("show.bs.collapse",function(){x.removeClass("btn-default").addClass("btn-primary"),h()}).on("hide.bs.collapse",function(){x.removeClass("btn-primary").addClass("btn-default"),v()}),t("ul#idAMapPositionPickerSearchResult").on("click","li[data-poi-index]",f))}function s(){b.css("height",R.opts.height),I.find("h4.modal-title").html(R.opts.title),M.hide()}function l(){M.hide(),E.getCurrentPosition(function(t,i){"complete"==t?g(m(i.position.lng,i.position.lat,i.formattedAddress)):M.html(i.message).show()})}function d(){j=o.empty(),null!=O&&O.setMap(null),A.val("")}function c(){j=R.getInitialPosition(),o.validate(j)?g(P(j)):null!=O&&(O.setMap(null),A.val(""))}function u(){return j.isValid()}function p(){var t=A.val();j.address=t;var i,e=u();i=e?j.copy():o.empty(),R.opts.required&&!e?M.html(R.opts.errorTip).show():(M.hide(),I.modal("hide"),R._onPickedCallback(i,e))}function f(i){var e=t(this).data("poiIndex");e<_.length&&_[e].resumeMove()}function h(){q.off("click",F),w.prop("disabled",!0),L.prop("disabled",!0),y.prop("disabled",!0),T.on("keydown",function(e){var n=T.val();"13"==e.which&&n.length>0&&i.service("AMap.PlaceSearch",function(){var e=new i.PlaceSearch({pageSize:6,pageIndex:1,extensions:"all"});e.searchInBounds(n,q.getBounds(),function(i,e){C.children("li").remove();for(var n in _)_[n].setMap(null);if(_=[],"complete"==i){for(var n in e.poiList.pois){var o=e.poiList.pois[n],a=t('<li data-poi-index="{i}" class="list-group-item"><small>{name}</small></li>'.format({i:n,name:o.name}));C.append(a);var r=m(o.location.lng,o.location.lat);r.on("click",function(t){g(t.target)}),_.push(r)}q.panTo(_[0].getPosition())}else S.append('<li class="list-group-item disabled"><small>抱歉，暂无找到符合条件的结果。</small></li>')})})})}function v(){q.on("click",F),w.prop("disabled",!1),L.prop("disabled",!1),y.prop("disabled",!1),T.val("").off("keydown");for(var t in _)_[t].setMap(null);_=[],C.children("li").remove()}function P(t){var e={map:q,position:new i.LngLat(t.longitude,t.latitude),topWhenClick:!0,offset:new i.Pixel((-5),(-30)),animation:"AMAP_ANIMATION_DROP",extData:t};t.address&&(e.title=t.address);var n=new i.Marker(e);return n}function m(t,i,e){var n=new o(t,i,e);return P(n)}function g(t){d(),O=t;var e=t.getExtData(),n=t.getPosition();if(j.longitude=e.longitude,j.latitude=e.latitude,e.address)j.address=e.address,q.panTo(n),A.val(e.address);else{var o;q.plugin(["AMap.Geocoder"],function(){o=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(o,"complete",function(t){if("OK"==t.info){var i=t.regeocode.formattedAddress;e.address=i,O.setExtData(e),j.address=i,A.val(i),q.panTo(n)}}),o.getAddress(n)})}}var b,A,M,k,y,w,L,x,S,T,C,E,R=null,q=null,I=null,O=null,j=o.empty(),_=[],F=function(t){M.hide(),g(m(t.lnglat.lng,t.lnglat.lat))};return{activate:e,deactivate:e}}(),s=function(t,i){function n(e,n){i.onPicked?i.onPicked(e):t.trigger("AMPP.PickCompleted",[e,n])}var s={isFirstLoad:!1,initialPosition:null,inputElList:[]},l=null;if(s._onPickedCallback=function(t,o){s.position(t),l.val(e(i.formatter,t));for(var a in s.inputElList)s.inputElList[a].render(t);n(t,o)},s.getInitialPosition=function(){return c},s.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},l=t.is("input")||t.is("textarea")?t:t.children("input"),l.prop("readonly",!0),o.LNGLAT_FORMATTER.indexOf(i.formatter)){var d=o.validateLngLat(l.val());d&&(i.value.longitude=parseFloat(d.longitude),i.value.latitude=parseFloat(d.latitude))}var c=new o(i.value.longitude,i.value.latitude,i.value.address);t.data("position",c.copy()),t.on("click",function(){r.activate(s)});var u=i.fields||[];for(var p in u){var f=new a(u[p]||{});f.created||l.after(f.$widget),s.inputElList.push(f)}return s.opts=i,s};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),o=!0,a=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),errorTip:e.data("errorTip"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")},center:{longitude:e.data("centerLongitude"),latitude:e.data("centerLatitude")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",s(e,i))}});if("string"==typeof i)return this.each(function(){var a=t(this),r=a.data("AMapPositionPicker");if(!r)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=r[i].apply(r,n),o=e===r}),o||t.inArray(i,a)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:null,value:{longitude:null,latitude:null,address:null},required:!0,title:"请选择地址",errorTip:"请选择地址",height:"500px",fields:[]},t.fn.AMapPositionPicker.version="v0.8.1",t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});