!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery","AMap"],t);else if("object"==typeof exports)module.exports=t(require("jquery"),require("AMap"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}function n(){var t='<div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerSearch" type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#idAMapPositionPickerSearchPanel"><span class="glyphicon glyphicon-search"></span>&nbsp;搜索</button></div>',i='<div id="idAMapPositionPickerSearchPanel" class="collapse"><input class="form-control input-sm" id="idAMapPositionPickerSearchInput"/><ul id="idAMapPositionPickerSearchResult" class="list-group"></ul></div>',e='<div id="idAMapPositionPickerFloatContainer" style="position: absolute;z-index: 2;top:5px;right: 5px;">'+t+i+"</div>",n='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">请选择地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+e+'</div><input class="form-control input-sm" style="margin-top:5px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary btn-sm">确定</button><button id="idAMapPositionPickerCancelBtn" type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button></div></div></div></div>';return n}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var o=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t.validateLngLat=function(t){var i=/^([+-]?(0?\d{1,2}(\.\d{1,6})?|1[0-7]?\d{1}(\.\d{1,6})?|180\.0{1,6}))[-;,]([-+]?([0-8]?\d{1}(\.\d{1,6})?|90(\.0{1,6})?))$/.exec(t);return i?{longitude:parseFloat(i[1]),latitude:parseFloat(i[5])}:null},t.LNGLAT_FORMATTER=["{longitude}-{latitude}","{longitude};{latitude}","{longitude},{latitude}"],t}(),a=function(){function i(t){return t.startsWith("#")?t.substring(1):(a+=1,"id_bapp_i"+a)}function n(n,a){if(this.name=n.name,n.selector instanceof jQuery)this.$widget=n.selector,this.created=!0;else if(t(n.selector).length>0)this.$widget=t(n.selector),this.created=!0;else{var s='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i(n.selector),name:n.name});this.$widget=t(s),this.created=!1}this.formatter=function(t){return e(n.formatter,t)},o.validate(a)&&this.$widget.val(this.formatter(a))}var a=-1;return n.prototype.render=function(t){var i=this.formatter(t);this.$widget.val(i)},n}(),s=function(){function e(t){F=t,a()}function a(){s(),r();var t=F.position();t&&t.isValid()?g(v(t)):(V&&V.setMap(null),k.val(""),F.opts.center.longitude&&F.opts.center.latitude&&O.setCenter(new i.LngLat(F.opts.center.longitude,F.opts.center.latitude))),_.modal("show")}function s(){null==_&&(_=t(n()),t(document.body).append(_),O=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){O.addControl(new i.ToolBar),O.addControl(new i.Scale),O.addControl(new i.OverView({isOpen:!0}))}),O.on("click",G),O.plugin("AMap.Geolocation",function(){q=new i.Geolocation({enableHighAccuracy:!0,timeout:3e3,maximumAge:0,convert:!0,panToLocation:!0,zoomToAccuracy:!0,markerOptions:{}})}),b=t("#idAMapPositionPickerMap"),w=t("#idAMapPositionPickerSelect"),L=t("#idAMapPositionPickerLocation"),x=t("#idAMapPositionPickerReset"),C=t("#idAMapPositionPickerClear"),k=t("#idAMapPositionPickerAddress"),S=t("#idAMapPositionPickerCancelBtn"),y=t("#idAMapPositionPickerAlert"),T=t("#idAMapPositionPickerSearch"),I=t("#idAMapPositionPickerSearchPanel"),E=t("#idAMapPositionPickerSearchInput"),R=t("#idAMapPositionPickerSearchResult"),w.on("click",p),x.on("click",c),C.on("click",d),L.on("click",l),I.on("show.bs.collapse",function(){T.removeClass("btn-default").addClass("btn-primary"),h()}).on("hide.bs.collapse",function(){T.removeClass("btn-primary").addClass("btn-default"),P()}),t("ul#idAMapPositionPickerSearchResult").on("click","li[data-poi-index]",f))}function r(){A(!1),b.css("height",F.opts.height),_.find("h4.modal-title").html(F.opts.title),y.hide()}function l(){y.hide(),q.getCurrentPosition(function(t,i){"complete"==t?g(m(i.position.lng,i.position.lat,i.formattedAddress)):y.html(i.message).show()})}function d(){$=o.empty(),null!=V&&V.setMap(null),k.val("")}function c(){$=F.getInitialPosition(),o.validate($)?g(v($)):null!=V&&(V.setMap(null),k.val(""))}function u(){return $.isValid()}function p(){if(j)return void _.modal("hide");var t=k.val();$.address=t;var i,e=u();i=e?$.copy():o.empty(),F.opts.required&&!e?y.html(F.opts.errorTip).show():(y.hide(),_.modal("hide"),F._onPickedCallback(i,e))}function f(i){var e=t(this).data("poiIndex");e<B.length&&B[e].resumeMove()}function h(){O.off("click",G),x.prop("disabled",!0),C.prop("disabled",!0),L.prop("disabled",!0),E.on("keydown",function(e){var n=E.val();"13"==e.which&&n.length>0&&i.service("AMap.PlaceSearch",function(){var e=new i.PlaceSearch({pageSize:6,pageIndex:1,extensions:"all"});e.searchInBounds(n,O.getBounds(),function(i,e){R.children("li").remove();for(var n in B)B[n].setMap(null);if(B=[],"complete"==i){for(var n in e.poiList.pois){var o=e.poiList.pois[n],a=t('<li data-poi-index="{i}" class="list-group-item"><small>{name}</small></li>'.format({i:n,name:o.name}));R.append(a);var s=m(o.location.lng,o.location.lat);s.on("click",function(t){g(t.target)}),B.push(s)}O.panTo(B[0].getPosition())}else I.append('<li class="list-group-item disabled"><small>抱歉，暂无找到符合条件的结果。</small></li>')})})})}function P(){O.on("click",G),x.prop("disabled",!1),C.prop("disabled",!1),L.prop("disabled",!1),E.val("").off("keydown");for(var t in B)B[t].setMap(null);B=[],R.children("li").remove()}function v(t){var e={map:O,position:new i.LngLat(t.longitude,t.latitude),topWhenClick:!0,offset:new i.Pixel((-5),(-30)),animation:"AMAP_ANIMATION_DROP",extData:t};t.address&&(e.title=t.address);var n=new i.Marker(e);return n}function m(t,i,e){var n=new o(t,i,e);return v(n)}function g(t){d(),V=t;var e=t.getExtData(),n=t.getPosition();if($.longitude=e.longitude,$.latitude=e.latitude,e.address)$.address=e.address,O.panTo(n),k.val(e.address);else{var o;O.plugin(["AMap.Geocoder"],function(){o=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(o,"complete",function(t){if("OK"==t.info){var i=t.regeocode.formattedAddress;e.address=i,V.setExtData(e),$.address=i,k.val(i),O.panTo(n)}}),o.getAddress(n)})}}function A(i){j=i,k.prop("readonly",i),i?(S.hide(),y.hide(),t("#idAMapPositionPickerFloatContainer").hide()):(t("#idAMapPositionPickerFloatContainer").show(),S.show())}function M(t){s(),A(!0),d();var i=v(t);O.panTo(i.getPosition()),k.val(t.address),_.modal("show")}var b,k,y,w,L,x,C,S,T,I,E,R,q,F=null,O=null,j=!1,_=null,V=null,$=o.empty(),B=[],G=function(t){y.hide(),g(m(t.lnglat.lng,t.lnglat.lat))};return{activate:e,deactivate:e,showPositionInMap:M}}(),r=function(t,i){function n(e,n){i.onPicked?i.onPicked(e):t.trigger("AMPP.PickCompleted",[e,n])}var r={isFirstLoad:!1,initialPosition:null,inputElList:[]},l=null;if(r._onPickedCallback=function(t,o){r.position(t),l.val(e(i.formatter,t));for(var a in r.inputElList)r.inputElList[a].render(t);n(t,o)},r.getInitialPosition=function(){return c},r.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},l=t.is("input")||t.is("textarea")?t:t.children("input"),l.prop("readonly",!0),o.LNGLAT_FORMATTER.indexOf(i.formatter)){var d=o.validateLngLat(l.val());d&&(i.value.longitude=parseFloat(d.longitude),i.value.latitude=parseFloat(d.latitude))}var c=new o(i.value.longitude,i.value.latitude,i.value.address);t.data("position",c.copy()),t.on("click",function(){s.activate(r)});var u=i.fields||[];for(var p in u){var f=new a(u[p]||{});f.created||l.after(f.$widget),r.inputElList.push(f)}return r.opts=i,r};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),o=!0,a=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),errorTip:e.data("errorTip"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")},center:{longitude:e.data("centerLongitude"),latitude:e.data("centerLatitude")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",r(e,i))}});if("string"==typeof i)return this.each(function(){var a=t(this),s=a.data("AMapPositionPicker");if(!s)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=s[i].apply(s,n),o=e===s}),o||t.inArray(i,a)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:null,value:{longitude:null,latitude:null,address:null},required:!0,title:"请选择地址",errorTip:"请选择地址",height:"500px",fields:[]},t.extend({AMapPositionPicker:{}}),t.extend(t.AMapPositionPicker,{showPositionInMap:function(t){s.showPositionInMap(t)},pluginVersion:"0.8.2"}),t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});