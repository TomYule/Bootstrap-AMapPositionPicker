!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery","AMap"],t);else if("object"==typeof exports)module.exports=t(require("jquery"),require("AMap"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}function n(){var t='<div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerSearch" type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#idAMapPositionPickerSearchPanel"><span class="glyphicon glyphicon-search"></span>&nbsp;搜索</button></div>',i='<div id="idAMapPositionPickerSearchPanel" class="collapse"><input class="form-control input-sm" id="idAMapPositionPickerSearchInput"/><ul id="idAMapPositionPickerSearchResult" class="list-group"></ul></div>',e='<div style="position: absolute;z-index: 2;top:5px;right: 5px;">'+t+i+"</div>",n='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">请选择地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+e+'</div><input class="form-control input-sm" style="margin-top:5px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary btn-sm">确定</button><button type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button></div></div></div></div>';return n}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var o=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t.validateLngLat=function(t){var i=/^([+-]?(0?\d{1,2}(\.\d{1,6})?|1[0-7]?\d{1}(\.\d{1,6})?|180\.0{1,6}))[-;,]([-+]?([0-8]?\d{1}(\.\d{1,6})?|90(\.0{1,6})?))$/.exec(t);return i?{longitude:parseFloat(i[1]),latitude:parseFloat(i[5])}:null},t.LNGLAT_FORMATTER=["{longitude}-{latitude}","{longitude};{latitude}","{longitude},{latitude}"],t}(),a=function(){function i(t){return t.startsWith("#")?t.substring(1):(a+=1,"id_bapp_i"+a)}function n(n,a){if(this.name=n.name,n.selector instanceof jQuery)this.$widget=n.selector,this.created=!0;else if(t(n.selector).length>0)this.$widget=t(n.selector),this.created=!0;else{var s='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i(n.selector),name:n.name});this.$widget=t(s),this.created=!1}this.formatter=function(t){return e(n.formatter,t)},o.validate(a)&&this.$widget.val(this.formatter(a))}var a=-1;return n.prototype.render=function(t){var i=this.formatter(t);this.$widget.val(i)},n}(),s=function(){function e(){null==S&&(S=t(n()),t(document.body).append(S),E=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){E.addControl(new i.ToolBar),E.addControl(new i.Scale),E.addControl(new i.OverView({isOpen:!0}))}),E.on("click",G),E.plugin("AMap.Geolocation",function(){x=new i.Geolocation({enableHighAccuracy:!0,timeout:3e3,maximumAge:0,convert:!0,panToLocation:!0,zoomToAccuracy:!0,markerOptions:{}})}),P=t("#idAMapPositionPickerMap"),A=t("#idAMapPositionPickerSelect"),M=t("#idAMapPositionPickerLocation"),y=t("#idAMapPositionPickerReset"),k=t("#idAMapPositionPickerClear"),m=t("#idAMapPositionPickerAddress"),b=t("#idAMapPositionPickerAlert"),w=t("#idAMapPositionPickerSearchPanel"),L=t("#idAMapPositionPickerSearchInput"),A.on("click",d),y.on("click",l),k.on("click",r),M.on("click",s),w.on("show.bs.collapse",function(){u()}).on("hide.bs.collapse",function(){c()}))}function a(t){P.css("height",t.height),S.find("h4.modal-title").html(t.title),b.hide()}function s(){b.hide(),x.getCurrentPosition(function(t,i){"complete"==t?(j.longitude=i.position.lng,j.latitude=i.position.lat,j.address=i.formattedAddress,v(j)):b.html(i.message).show()})}function r(){j=o.empty(),O.setMap(null),m.val("")}function l(){j=C.getInitialPosition(),o.validate(j)?v(j):(O.setMap(null),m.val(""))}function d(){var t=m.val();j.address=t,T.required&&!j.isValid()?b.html("请选择地址").show():(b.hide(),S.modal("hide"),C._onPickedCallback(j.copy({address:t})))}function u(){E.off("click",G),y.prop("disabled",!0),k.prop("disabled",!0),M.prop("disabled",!0),L.on("keydown",function(e){"13"==e.which&&L.val().length>0&&i.service("AMap.PlaceSearch",function(){var e=E.getBounds(),n=new i.PlaceSearch({pageSize:6,pageIndex:1,extensions:"all"});n.searchInBounds(L.val(),e,function(i,e){w.children("li").remove();for(var n in q)q[n].setMap(null);if(q=[],"complete"==i){for(var n in e.poiList.pois){var a=e.poiList.pois[n],s=t('<li class="list-group-item"><small>{name}</small></li>'.format({name:a.name}));w.append(s);var r=p(new o(a.location.lng,a.location.lat,a.address));q.push(r)}E.panTo(q[0].getPosition())}else w.append("<li><small>抱歉，暂无找到符合条件的结果。</small></li>")})})})}function c(){E.on("click",G),y.prop("disabled",!1),k.prop("disabled",!1),M.prop("disabled",!1),L.val("").off("keydown");for(var t in q)q[t].setMap(null);q=[],w.children("li").remove()}function p(t){var e=new i.Marker({map:E,position:new i.LngLat(t.longitude,t.latitude),topWhenClick:!0,offset:new i.Pixel((-5),(-30)),extData:t});return e.on("click",function(t){f(t.target),h(t.target)}),e}function f(t){var e=t.getExtData();if(!e.address){var n;E.plugin(["AMap.Geocoder"],function(){n=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(n,"complete",function(i){"OK"==i.info&&(e.address=i.regeocode.formattedAddress,t.setExtData(e))}),n.getAddress(t.getPosition())})}}function h(t){O=t,j.longitude=t.getPosition().lng,j.latitude=t.getPosition().lat,m.val(t.getExtData().address),E.panTo(t.getPosition())}function g(){e(),a(T);var t=C.position();t&&t.isValid()?(j=t,v(C.position())):(O&&O.setMap(null),m.val(""),T.center.longitude&&T.center.latitude&&E.setCenter(new i.LngLat(T.center.longitude,T.center.latitude))),S.modal("show")}function v(t,e,n){function a(){null!=O&&O.setMap(null),n||(O=new i.Marker({map:E,position:e,topWhenClick:!0,offset:new i.Pixel((-5),(-30))})),m.val(s),E.setCenter(e)}void 0==n&&(n=!1);var s="";if(void 0==e){if(!o.validate(t))return;e=new i.LngLat(t.longitude,t.latitude),s=t.address}if(s)a();else{var r;E.plugin(["AMap.Geocoder"],function(){r=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(r,"complete",function(t){"OK"==t.info&&(s=t.regeocode.formattedAddress),a()}),r.getAddress(e)})}}var P,m,b,A,M,y,k,w,L,x,S=null,C=null,T=null,E=null,q=[],O=null,j=o.empty(),G=function(t){b.hide(),j.longitude=t.lnglat.lng,j.latitude=t.lnglat.lat,v(void 0,t.lnglat)};return{showModal:g,startContext:function(t,i){return C=t,T=i,this},endContext:function(){return this}}}(),r=function(t,i){var n={isFirstLoad:!1,initialPosition:null,inputElList:[]},r=null;if(n._onPickedCallback=function(t){n.position(t),r.val(e(i.formatter,t));for(var o in n.inputElList)n.inputElList[o].render(t);i.onPicked(t)},n.getInitialPosition=function(){return d},n.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},r=t.is("input")||t.is("textarea")?t:t.children("input"),r.prop("readonly",!0),o.LNGLAT_FORMATTER.indexOf(i.formatter)){var l=o.validateLngLat(r.val());l&&(i.value.longitude=parseFloat(l.longitude),i.value.latitude=parseFloat(l.latitude))}var d=new o(i.value.longitude,i.value.latitude,i.value.address);t.data("position",d.copy()),t.on("click",function(){s.startContext(n,i).showModal()});var u=i.fields||[];for(var c in u){var p=new a(u[c]||{});p.created||r.after(p.$widget),n.inputElList.push(p)}return n};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),o=!0,a=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")},center:{longitude:e.data("centerLongitude"),latitude:e.data("centerLatitude")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",r(e,i))}});if("string"==typeof i)return this.each(function(){var a=t(this),s=a.data("AMapPositionPicker");if(!s)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=s[i].apply(s,n),o=e===s}),o||t.inArray(i,a)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:function(t){},value:{longitude:null,latitude:null,address:null},required:!0,title:"请选择地址",height:"500px",fields:[]},t.fn.AMapPositionPicker.version="v0.7.0",t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});