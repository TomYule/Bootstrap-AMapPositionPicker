!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery"],t);else if("object"==typeof exports)module.exports=t(require("jquery"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var n=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t}(),o=function(){function i(e,o){if(this.name=e.name,e.selector instanceof jQuery)this.$instance=e.selector,this.created=!0;else if(t(e.selector).length>0)this.$instance=t(e.selector),this.created=!0;else{var a='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i.generateSelectorId(e.selector),name:e.name});this.$instance=t(a),this.created=!1}this.formatter=e.formatter,n.validate(o)&&this.$instance.val(this.format(o))}return i.prototype.render=function(t){var i=e(this.formatter,t);this.$instance.val(i)},i.id_index=-1,i.generateSelectorId=function(t){return t.startsWith("#")?t.substring(1):(i.id_index+=1,"id_bapp_i"+i.id_index)},i}(),a=function(){function e(){null==g&&(g=t(y),t(document.body).append(g),M=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){M.addControl(new i.ToolBar),M.addControl(new i.Scale),M.addControl(new i.OverView({isOpen:!0}))}),i.event.addListener(M,"click",function(t){p.hide(),w.longitude=t.lnglat.lng,w.latitude=t.lnglat.lat,l(void 0,t.lnglat)}),u=t("#idAMapPositionPickerMap"),f=t("#idAMapPositionPickerSelect"),h=t("#idAMapPositionPickerLocation"),v=t("#idAMapPositionPickerReset"),P=t("#idAMapPositionPickerClear"),c=t("#idAMapPositionPickerAddress"),p=t("#idAMapPositionPickerAlert"),f.on("click",r),v.on("click",s),P.on("click",a))}function o(t){u.css("height",t.height),g.find("h4.modal-title").html(t.title),p.hide()}function a(){w=n.empty(),b.setMap(null),c.val("")}function s(){w=A.getInitialPosition(),n.validate(w)?l(w):(b.setMap(null),c.val(""))}function r(){var t=c.val();w.address=t,k.required&&!w.isValid()?p.show():(p.hide(),A._onPickedCallback(w.copy({address:t})),g.modal("hide"))}function d(){e(),o(k);var t=A.position();t&&t.isValid()?(w=t,l(A.position())):(b&&b.setMap(null),c.val("")),g.modal("show")}function l(t,e){function o(){null!=b&&b.setMap(null),b=new i.Marker({map:M,position:e,topWhenClick:!0,offset:new i.Pixel((-5),(-30))}),c.val(a),M.setCenter(e)}var a="";if(void 0==e){if(!n.validate(t))return;e=new i.LngLat(t.longitude,t.latitude),a=t.address}if(a)o();else{var s;M.plugin(["AMap.Geocoder"],function(){s=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(s,"complete",function(t){"OK"==t.info&&(a=t.regeocode.formattedAddress),o()}),s.getAddress(e)})}}var u,c,p,f,h,v,P,m='<div style="position: absolute;z-index: 2;top:5px;right: 5px;"><div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default disabled"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button> </div></div>',y='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">选择详细地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+m+'</div><input class="form-control" style="margin-top:10px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary">确定</button><button type="button" class="btn btn-default" data-dismiss="modal">取消</button></div></div></div></div>',g=null,M=null,b=null,A=null,k=null,w=n.empty();return{showModal:d,startContext:function(t,i){return A=t,k=i,this},endContext:function(){return this}}}(),s=function(t,i){var e={isFirstLoad:!1,initialPosition:null,inputElList:[]},s=null,r=new n(i.value.longitude,i.value.latitude,i.value.address);e._onPickedCallback=function(t){e.position(t),s.val(i.formatter.format(t));for(var n in e.inputElList)e.inputElList[n].render(t);i.onPicked(t)},e.getInitialPosition=function(){return r},e.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},t.data("position",r.copy()),s=t.is("input")?t:t.children("input"),s.prop("readonly",!0),t.on("click",function(){a.startContext(e,i).showModal()});var d=i.fields||[];for(var l in d){var u=new o(d[l]||{});u.created||t.after(u.$instance),e.inputElList.push(u)}return e};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),o=!0,a=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",s(e,i))}});if("string"==typeof i)return this.each(function(){var a=t(this),s=a.data("AMapPositionPicker");if(!s)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=s[i].apply(s,n),o=e===s}),o||t.inArray(i,a)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:function(t){},value:{longitude:null,latitude:null,address:null},required:!0,title:"请输入地址",height:"500px",fields:[]},t.fn.AMapPositionPicker.version="v0.5.0",t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});