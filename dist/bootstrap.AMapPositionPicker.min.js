!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery"],t);else if("object"==typeof exports)module.exports=t(require("jquery"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var n=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t}(),o=function(){function i(o,a){if(this.name=o.name,o.selector instanceof jQuery)this.$instance=o.selector,this.created=!0;else if(t(o.selector).length>0)this.$instance=t(o.selector),this.created=!0;else{var s='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i.generateSelectorId(o.selector),name:o.name});this.$instance=t(s),this.created=!1}this.formatter=function(t){return e(o.formatter,t)},n.validate(a)&&this.$instance.val(this.formatter(a))}return i.prototype.render=function(t){var i=this.formatter(t);this.$instance.val(i)},i.id_index=-1,i.generateSelectorId=function(t){return t.startsWith("#")?t.substring(1):(i.id_index+=1,"id_bapp_i"+i.id_index)},i}(),a=function(){function e(){null==M&&(M=t(A),t(document.body).append(M),b=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){b.addControl(new i.ToolBar),b.addControl(new i.Scale),b.addControl(new i.OverView({isOpen:!0}))}),i.event.addListener(b,"click",function(t){f.hide(),C.longitude=t.lnglat.lng,C.latitude=t.lnglat.lat,u(void 0,t.lnglat)}),b.plugin("AMap.Geolocation",function(){g=new i.Geolocation({enableHighAccuracy:!0,timeout:3e3,maximumAge:0,convert:!0,panToLocation:!0,zoomToAccuracy:!0,markerOptions:{}})}),c=t("#idAMapPositionPickerMap"),h=t("#idAMapPositionPickerSelect"),v=t("#idAMapPositionPickerLocation"),P=t("#idAMapPositionPickerReset"),m=t("#idAMapPositionPickerClear"),p=t("#idAMapPositionPickerAddress"),f=t("#idAMapPositionPickerAlert"),h.on("click",d),P.on("click",r),m.on("click",s),v.on("click",a))}function o(t){c.css("height",t.height),M.find("h4.modal-title").html(t.title),f.hide()}function a(){f.hide(),g.getCurrentPosition(function(t,i){"complete"==t?(C.longitude=i.position.lng,C.latitude=i.position.lat,C.address=i.formattedAddress,u(C)):f.html(i.message).show()})}function s(){C=n.empty(),k.setMap(null),p.val("")}function r(){C=w.getInitialPosition(),n.validate(C)?u(C):(k.setMap(null),p.val(""))}function d(){var t=p.val();C.address=t,x.required&&!C.isValid()?f.html("请选择地址").show():(f.hide(),M.modal("hide"),w._onPickedCallback(C.copy({address:t})))}function l(){e(),o(x);var t=w.position();t&&t.isValid()?(C=t,u(w.position())):(k&&k.setMap(null),p.val("")),M.modal("show")}function u(t,e){function o(){null!=k&&k.setMap(null),k=new i.Marker({map:b,position:e,topWhenClick:!0,offset:new i.Pixel((-5),(-30))}),p.val(a),b.setCenter(e)}var a="";if(void 0==e){if(!n.validate(t))return;e=new i.LngLat(t.longitude,t.latitude),a=t.address}if(a)o();else{var s;b.plugin(["AMap.Geocoder"],function(){s=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(s,"complete",function(t){"OK"==t.info&&(a=t.regeocode.formattedAddress),o()}),s.getAddress(e)})}}var c,p,f,h,v,P,m,g,y='<div style="position: absolute;z-index: 2;top:5px;right: 5px;"><div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button> </div></div>',A='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">请选择地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+y+'</div><input class="form-control" style="margin-top:10px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary">确定</button><button type="button" class="btn btn-default" data-dismiss="modal">取消</button></div></div></div></div>',M=null,b=null,k=null,w=null,x=null,C=n.empty();return{showModal:l,startContext:function(t,i){return w=t,x=i,this},endContext:function(){return this}}}(),s=function(t,i){var s={isFirstLoad:!1,initialPosition:null,inputElList:[]},r=null,d=new n(i.value.longitude,i.value.latitude,i.value.address);s._onPickedCallback=function(t){s.position(t),r.val(e(i.formatter,t));for(var n in s.inputElList)s.inputElList[n].render(t);i.onPicked(t)},s.getInitialPosition=function(){return d},s.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},t.data("position",d.copy()),r=t.is("input")?t:t.children("input"),r.prop("readonly",!0),t.on("click",function(){a.startContext(s,i).showModal()});var l=i.fields||[];for(var u in l){var c=new o(l[u]||{});c.created||t.after(c.$instance),s.inputElList.push(c)}return s};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),o=!0,a=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",s(e,i))}});if("string"==typeof i)return this.each(function(){var a=t(this),s=a.data("AMapPositionPicker");if(!s)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=s[i].apply(s,n),o=e===s}),o||t.inArray(i,a)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:function(t){},value:{longitude:null,latitude:null,address:null},required:!0,title:"请输入地址",height:"500px",fields:[]},t.fn.AMapPositionPicker.version="v0.6.0",t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});