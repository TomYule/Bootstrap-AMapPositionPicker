!function(t){"use strict";if("function"==typeof define&&define.amd)define(["jquery","AMap"],t);else if("object"==typeof exports)module.exports=t(require("jquery"),require("AMap"));else{if("undefined"==typeof jQuery)throw"bootstrap.AMapPositionPicker requires jQuery to be loaded first";if("undefined"==typeof AMap)throw"bootstrap.AMapPositionPicker requires AMap to be loaded first";t(jQuery,AMap)}}(function(t,i){function e(t,i){return"function"==typeof t?t(i):"string"==typeof t?t.format(i):""}function n(){var t='<div class="btn-group"><button id="idAMapPositionPickerLocation" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;定位</button><button id="idAMapPositionPickerReset" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-repeat"></span>&nbsp;重置</button><button id="idAMapPositionPickerClear" type="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove"></span>&nbsp;清除</button><button id="idAMapPositionPickerSearch" type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#idAMapPositionPickerSearchPanel"><span class="glyphicon glyphicon-search"></span>&nbsp;搜索</button></div>',i='<div id="idAMapPositionPickerSearchPanel" class="collapse"><input class="form-control input-sm" id="idAMapPositionPickerSearchInput"/><ul id="idAMapPositionPickerSearchResult" class="list-group"></ul></div>',e='<div style="position: absolute;z-index: 2;top:5px;right: 5px;">'+t+i+"</div>",n='<div class="modal fade" id="idAMapPositionPickerModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><h4 class="modal-title">请选择地址</h4><small id="idAMapPositionPickerAlert" style="color: red">必须选择一个位置</small></div><div class="modal-body"><div id="idAMapPositionPickerMap" style="height: 500px;" class="form-control">'+e+'</div><input class="form-control input-sm" style="margin-top:5px;" id="idAMapPositionPickerAddress"/></div><div class="modal-footer"><button id="idAMapPositionPickerSelect" type="button" class="btn btn-primary btn-sm">确定</button><button type="button" class="btn btn-default btn-sm" data-dismiss="modal">取消</button></div></div></div></div>';return n}String.prototype.format=function(t){var i=this;for(var e in t)if(void 0!=t[e]){var n=new RegExp("({"+e+"})","g");i=i.replace(n,t[e])}return i},"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(t){return this.slice(0,t.length)===t});var a=function(){function t(t,i,e){this.longitude=t,this.latitude=i,this.address=e||""}return t.prototype.isValid=function(){return void 0!=this.longitude&&null!=this.longitude&&void 0!=this.latitude&&null!=this.latitude},t.prototype.copy=function(i){return void 0==i?new t(this.longitude,this.latitude,this.address):new t(i.longitude||this.longitude,i.latitude||this.latitude,i.address||this.address)},t.empty=function(){return new t(null,null,"")},t.validate=function(t){return!!t&&t.isValid()},t.validateLngLat=function(t){var i=/^([+-]?(0?\d{1,2}(\.\d{1,6})?|1[0-7]?\d{1}(\.\d{1,6})?|180\.0{1,6}))[-;,]([-+]?([0-8]?\d{1}(\.\d{1,6})?|90(\.0{1,6})?))$/.exec(t);return i?{longitude:parseFloat(i[1]),latitude:parseFloat(i[5])}:null},t.LNGLAT_FORMATTER=["{longitude}-{latitude}","{longitude};{latitude}","{longitude},{latitude}"],t}(),o=function(){function i(t){return t.startsWith("#")?t.substring(1):(o+=1,"id_bapp_i"+o)}function n(n,o){if(this.name=n.name,n.selector instanceof jQuery)this.$widget=n.selector,this.created=!0;else if(t(n.selector).length>0)this.$widget=t(n.selector),this.created=!0;else{var s='<input type="hidden" id="{id}" name="{name}"/>'.format({id:i(n.selector),name:n.name});this.$widget=t(s),this.created=!1}this.formatter=function(t){return e(n.formatter,t)},a.validate(o)&&this.$widget.val(this.formatter(o))}var o=-1;return n.prototype.render=function(t){var i=this.formatter(t);this.$widget.val(i)},n}(),s=function(){function e(t){E=t,o()}function o(){s(),r();var t=E.position();t&&t.isValid()?m(v(t)):(I&&I.setMap(null),b.val(""),E.opts.center.longitude&&E.opts.center.latitude&&R.setCenter(new i.LngLat(E.opts.center.longitude,E.opts.center.latitude))),q.modal("show")}function s(){null==q&&(q=t(n()),t(document.body).append(q),R=new i.Map("idAMapPositionPickerMap",{zoom:15}),i.plugin(["AMap.ToolBar","AMap.Scale","AMap.OverView"],function(){R.addControl(new i.ToolBar),R.addControl(new i.Scale),R.addControl(new i.OverView({isOpen:!0}))}),R.on("click",_),R.plugin("AMap.Geolocation",function(){C=new i.Geolocation({enableHighAccuracy:!0,timeout:3e3,maximumAge:0,convert:!0,panToLocation:!0,zoomToAccuracy:!0,markerOptions:{}})}),g=t("#idAMapPositionPickerMap"),M=t("#idAMapPositionPickerSelect"),y=t("#idAMapPositionPickerLocation"),k=t("#idAMapPositionPickerReset"),w=t("#idAMapPositionPickerClear"),b=t("#idAMapPositionPickerAddress"),A=t("#idAMapPositionPickerAlert"),L=t("#idAMapPositionPickerSearch"),x=t("#idAMapPositionPickerSearchPanel"),S=t("#idAMapPositionPickerSearchInput"),T=t("#idAMapPositionPickerSearchResult"),M.on("click",u),k.on("click",c),w.on("click",d),y.on("click",l),x.on("show.bs.collapse",function(){L.removeClass("btn-default").addClass("btn-primary"),f()}).on("hide.bs.collapse",function(){L.removeClass("btn-primary").addClass("btn-default"),h()}),t("ul#idAMapPositionPickerSearchResult").on("click","li[data-poi-index]",p))}function r(){g.css("height",E.opts.height),q.find("h4.modal-title").html(E.opts.title),A.hide()}function l(){A.hide(),C.getCurrentPosition(function(t,i){"complete"==t?m(P(i.position.lng,i.position.lat,i.formattedAddress)):A.html(i.message).show()})}function d(){O=a.empty(),null!=I&&I.setMap(null),b.val("")}function c(){O=E.getInitialPosition(),a.validate(O)?m(v(O)):null!=I&&(I.setMap(null),b.val(""))}function u(){var t=b.val();O.address=t,E.opts.required&&!O.isValid()?A.html(E.opts.errorTip).show():(A.hide(),q.modal("hide"),E._onPickedCallback(O.copy({address:t})))}function p(i){var e=t(this).data("poiIndex");e<j.length&&j[e].resumeMove()}function f(){R.off("click",_),k.prop("disabled",!0),w.prop("disabled",!0),y.prop("disabled",!0),S.on("keydown",function(e){var n=S.val();"13"==e.which&&n.length>0&&i.service("AMap.PlaceSearch",function(){var e=new i.PlaceSearch({pageSize:6,pageIndex:1,extensions:"all"});e.searchInBounds(n,R.getBounds(),function(i,e){T.children("li").remove();for(var n in j)j[n].setMap(null);if(j=[],"complete"==i){for(var n in e.poiList.pois){var a=e.poiList.pois[n],o=t('<li data-poi-index="{i}" class="list-group-item"><small>{name}</small></li>'.format({i:n,name:a.name}));T.append(o);var s=P(a.location.lng,a.location.lat);s.on("click",function(t){m(t.target)}),j.push(s)}R.panTo(j[0].getPosition())}else x.append('<li class="list-group-item disabled"><small>抱歉，暂无找到符合条件的结果。</small></li>')})})})}function h(){R.on("click",_),k.prop("disabled",!1),w.prop("disabled",!1),y.prop("disabled",!1),S.val("").off("keydown");for(var t in j)j[t].setMap(null);j=[],T.children("li").remove()}function v(t){var e={map:R,position:new i.LngLat(t.longitude,t.latitude),topWhenClick:!0,offset:new i.Pixel((-5),(-30)),animation:"AMAP_ANIMATION_DROP",extData:t};t.address&&(e.title=t.address);var n=new i.Marker(e);return n}function P(t,i,e){var n=new a(t,i,e);return v(n)}function m(t){I=t;var e=t.getExtData(),n=t.getPosition();if(O.longitude=e.longitude,O.latitude=e.latitude,e.address)O.address=e.address,R.panTo(n),b.val(e.address);else{var a;R.plugin(["AMap.Geocoder"],function(){a=new i.Geocoder({radius:1e3,extensions:"base"}),i.event.addListener(a,"complete",function(t){if("OK"==t.info){var i=t.regeocode.formattedAddress;e.address=i,I.setExtData(e),O.address=i,b.val(i),R.panTo(n)}}),a.getAddress(n)})}}var g,b,A,M,y,k,w,L,x,S,T,C,E=null,R=null,q=null,I=null,O=a.empty(),j=[],_=function(t){A.hide(),m(P(t.lnglat.lng,t.lnglat.lat))};return{activate:e,deactivate:e}}(),r=function(t,i){var n={isFirstLoad:!1,initialPosition:null,inputElList:[]},r=null;if(n._onPickedCallback=function(t){n.position(t),r.val(e(i.formatter,t));for(var a in n.inputElList)n.inputElList[a].render(t);i.onPicked(t)},n.getInitialPosition=function(){return d},n.position=function(i){return void 0==i?t.data("position"):void t.data("position",i)},r=t.is("input")||t.is("textarea")?t:t.children("input"),r.prop("readonly",!0),a.LNGLAT_FORMATTER.indexOf(i.formatter)){var l=a.validateLngLat(r.val());l&&(i.value.longitude=parseFloat(l.longitude),i.value.latitude=parseFloat(l.latitude))}var d=new a(i.value.longitude,i.value.latitude,i.value.address);t.data("position",d.copy()),t.on("click",function(){s.activate(n)});var c=i.fields||[];for(var u in c){var p=new o(c[u]||{});p.created||r.after(p.$widget),n.inputElList.push(p)}return n.opts=i,n};t.fn.AMapPositionPicker=function(i){i=i||{};var e,n=Array.prototype.slice.call(arguments,1),a=!0,o=[];if("object"==typeof i)return this.each(function(){var e=t(this);if(!e.data("AMapPositionPicker")){var n={formatter:e.data("formatter"),title:e.data("title"),errorTip:e.data("errorTip"),height:e.data("height"),required:e.data("required"),value:{longitude:e.data("valueLongitude"),latitude:e.data("valueLatitude"),address:e.data("valueAddress")},center:{longitude:e.data("centerLongitude"),latitude:e.data("centerLatitude")}};i=t.extend(!0,{},t.fn.AMapPositionPicker.defaults,n,i),e.data("AMapPositionPicker",r(e,i))}});if("string"==typeof i)return this.each(function(){var o=t(this),s=o.data("AMapPositionPicker");if(!s)throw new Error('bootstrap.AMapPositionPicker("'+i+'") method was called on an element that is not using AMapPositionPicker');e=s[i].apply(s,n),a=e===s}),a||t.inArray(i,o)>-1?this:e;throw new TypeError("Invalid arguments for AMapPositionPicker: "+i)},t.fn.AMapPositionPicker.defaults={formatter:"{address}",onPicked:function(t){},value:{longitude:null,latitude:null,address:null},required:!0,title:"请选择地址",errorTip:"请选择地址",height:"500px",fields:[]},t.fn.AMapPositionPicker.version="v0.8.0",t(function(){t('[data-provide="AMapPositionPicker"]').AMapPositionPicker()})});